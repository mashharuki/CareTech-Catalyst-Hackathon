# Implementation Tasks

- [ ] 1. 実行境界と共通基盤の初期化
- [x] 1.1 常駐API境界、運用コマンド境界、共通基盤境界の依存方向を固定する
  - フロントエンド、常駐API、運用コマンド、共通基盤、契約実行層の責務境界を確定する。
  - 相互直接依存を禁止するルールを実装時チェック可能な形で適用する。
  - _Requirements: 3.1, 3.4_
- [ ] 1.2 provider設定とネットワーク接続ユーティリティを共通化する
  - 接続設定、環境切替、失敗時の基本ログを共通基盤経由で再利用可能にする。
  - 常駐APIと運用コマンドの両方で同一挙動を保証する。
  - _Requirements: 5.1, 5.3, 5.5_
- [ ] 1.3 認可スコープとロール判定の共通ポリシーを確立する
  - 役割ごとの許可操作をスコープで判定できるようにする。
  - 未許可操作を一貫したエラー理由で拒否する。
  - _Requirements: 3.1, 4.4, 4.5_

- [ ] 2. 参加者管理機能を実装する
- [ ] 2.1 (P) 参加申請の検証と登録を実装する
  - 必須属性の検証、重複拒否、登録成功時の状態初期化を行う。
  - 不備時は不足/不整合理由を返す。
  - _Requirements: 1.1, 1.2_
- [ ] 2.2 (P) 参加者状態遷移と信頼レベル管理を実装する
  - 有効/停止/再開の状態遷移を履歴付きで管理する。
  - 信頼レベルを連携可否判定に利用できる状態で保持する。
  - _Requirements: 1.3, 1.4, 1.5_
- [ ] 2.3 参加者管理APIの操作フローを統合する
  - 認可、検証、状態更新、監査イベント記録を一連で処理する。
  - _Requirements: 1.1, 1.2, 1.5, 4.1_

- [ ] 3. 同意管理と評価機能を実装する
- [ ] 3.1 (P) 同意条件の登録・更新を実装する
  - 対象データ種別、共有先、利用目的、有効期間を同意条件として保持する。
  - _Requirements: 2.1, 2.5_
- [ ] 3.2 (P) 同意の部分撤回と版管理を実装する
  - 部分撤回対象のみ無効化し、履歴と最新状態を整合させる。
  - _Requirements: 2.3, 2.4, 2.5_
- [ ] 3.3 同意評価ロジックを判定サービスへ統合する
  - 同意不一致時の拒否理由を判定結果へ反映する。
  - _Requirements: 2.2, 2.3, 2.5_

- [ ] 4. 連携要求判定フローを実装する
- [ ] 4.1 連携要求受付と追跡ID発行を実装する
  - 要求の妥当性検証を行い、全処理を追跡IDで関連付ける。
  - _Requirements: 3.1, 3.5_
- [ ] 4.2 参加者信頼・同意条件を統合した判定を実装する
  - 条件一致時の承認、条件不一致時の不承認を理由付きで返す。
  - 判定不能時は安全側（保留/不承認）へ遷移する。
  - _Requirements: 3.2, 3.3, 5.2_
- [ ] 4.3 判定状態参照と通知連携を実装する
  - 処理中/完了ステータスの参照を可能にする。
  - 承認結果の通知連携ポートを実装し、通知失敗時の扱いを定義する。
  - _Requirements: 3.2, 3.4, 3.5_

- [ ] 5. 監査証跡と外部監査連携を実装する
- [ ] 5.1 監査イベントの追記専用記録と検索を実装する
  - 操作主体、時刻、対象、結果を検索可能な形で保持する。
  - _Requirements: 4.1, 4.3, 4.5_
- [ ] 5.2 監査整合チェックと改変疑い検知を実装する
  - 欠落・改変疑いを検知してアラート通知する。
  - _Requirements: 4.2, 4.5_
- [ ] 5.3 監査エクスポートジョブを実装する
  - エクスポート認可条件、期間上限、実行履歴追跡を適用する。
  - _Requirements: 4.4, 4.5_

- [ ] 6. 判定・監査整合の回復戦略を実装する
- [ ] 6.1 Outbox駆動の非同期連携フローを実装する
  - 判定結果からアンカー記録と監査記録を順序実行する。
  - _Requirements: 3.5, 4.5_
- [ ] 6.2 片側成功時の補償フローを実装する
  - アンカー成功/監査失敗、アンカー失敗/監査成功の補償処理を実装する。
  - _Requirements: 3.3, 4.5, 5.5_
- [ ] 6.3 依存障害時の再試行と保留再評価を実装する
  - 再試行上限、保留維持、再評価完了条件を状態機械で管理する。
  - _Requirements: 5.1, 5.2, 5.3, 5.5_

- [ ] 7. 運用可観測性と管理UIを実装する
- [ ] 7.1 (P) 運用メトリクス収集を実装する
  - 成功率、遅延、エラー件数を集計し、運用者が参照できるようにする。
  - _Requirements: 5.4_
- [ ] 7.2 常駐API連携の管理UIフローを実装する
  - 参加者管理、同意管理、要求状態、監査検索の主要操作を統合する。
  - _Requirements: 1.1, 2.1, 3.4, 4.3, 5.3_
- [ ] 7.3 障害時の可視化と運用ハンドリングを実装する
  - 保留件数、再評価待ち、依存障害状態を運用画面で把握できるようにする。
  - _Requirements: 5.1, 5.3, 5.4_

- [ ] 8. テストと品質ゲートを整備する
- [ ] 8.1 ドメイン単体テストを整備する
  - 参加者管理、同意評価、判定分岐、監査整合、再試行制御を検証する。
  - _Requirements: 1.1, 1.4, 2.2, 3.3, 4.5, 5.2_
- [ ] 8.2 統合テストを整備する
  - 要求受付から判定、監査記録、補償、再評価までの一連フローを検証する。
  - _Requirements: 3.1, 3.5, 4.1, 4.5, 5.5_
- [ ]* 8.3 負荷・回復テストを追加する
  - 高負荷時の遅延と保留再評価挙動を確認し、運用閾値調整に反映する。
  - _Requirements: 5.1, 5.4, 5.5_
