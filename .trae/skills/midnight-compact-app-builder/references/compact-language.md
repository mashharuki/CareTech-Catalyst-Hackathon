# Compact Language Guide

## Goal

Compact 契約実装で失敗しやすい点を避け、テスト可能な設計へ導く。

## Design Rules

- 公開情報と秘匿情報を最初に分離する。
- 「何を証明するか」を自然言語で先に定義し、回路へ落とし込む。
- witness は最小化し、境界条件を明文化する。
- 仕様の曖昧さを残したまま実装に入らない。

## Contract Modeling Checklist

1. 状態遷移図を用意する（初期状態、遷移条件、失敗条件）。
2. 各回路の入力・出力・前提条件を定義する。
3. 失敗時に拒否すべき条件を列挙する。
4. 監査観点で、漏れている検証条件がないか確認する。

## Implementation Strategy

- 先に最小機能の回路を作り、段階的に拡張する。
- 1 回路ずつテストを通し、複数回路同時変更を避ける。
- 型エラーは設計不一致のシグナルとして扱い、場当たり修正しない。

## TDD Pattern for Compact

1. 期待する振る舞い（正常系/異常系）をテストに先書き。
2. 最小実装でテストを通す。
3. リファクタリングで重複削減。
4. 次の境界条件テストを追加。

推奨テスト観点:
- 許可される入力
- 拒否される入力
- 状態遷移の前後整合
- 連続実行時の整合
- 不正順序呼び出し

## Security Practices

- 最小権限原則で状態更新を設計する。
- 想定外入力を黙って受け入れない。
- 「検証しない前提」を残さない。
- 秘匿データの漏えい経路（ログ・エラー文・イベント）をレビューする。

## Refactoring Boundaries

以下は一括変更せず、小さい差分に分ける。

- 状態表現の変更
- witness 構造変更
- 複数回路にまたがる共通ロジック変更

各ステップでテストを固定点にする。
